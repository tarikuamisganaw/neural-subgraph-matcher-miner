name: Run Decoder

on:
  push:
    branches: [main,cryptocurrency-dataset]
  pull_request:
    branches: [main,cryptocurrency-dataset]
  workflow_dispatch:

jobs:
  run-decoder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.7'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libfreetype6-dev \
            libpng-dev \
            libqhull-dev \
            gfortran \
            libopenblas-dev \
            liblapack-dev \
            libatlas-base-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install numpy==1.21.6
          pip install matplotlib==2.1.1 scikit-learn==1.0.2 seaborn==0.9.0
          pip install torch==1.4.0+cpu torchvision==0.5.0+cpu -f https://download.pytorch.org/whl/torch_stable.html
          pip install torch-scatter==2.0.2 torch-sparse==0.6.1 torch-cluster==1.5.4 torch-spline-conv==1.2.0 torch-geometric==1.4.3 --find-links https://data.pyg.org/whl/torch-1.4.0+cpu.html
          pip install deepsnap==0.1.2 networkx==2.4 test-tube==0.7.5 tqdm==4.43.0

      - name: Create output directories
        run: |
          mkdir -p plots/cluster
          mkdir -p results
          chmod -R 777 plots
          chmod -R 777 results

      - name: Check available processors and usage percentage
        id: cpu-check
        run: |
          TOTAL_CPUS=$(nproc)
          USED_CPUS=4
          PERCENT_USED=$(( 100 * USED_CPUS / TOTAL_CPUS ))
          echo "Total available processors: $TOTAL_CPUS"
          echo "Processors used for decoder: $USED_CPUS"
          echo "Percent of processors used: ${PERCENT_USED}%"
          echo "total_cpus=$TOTAL_CPUS" >> $GITHUB_OUTPUT
          echo "percent_used=$PERCENT_USED" >> $GITHUB_OUTPUT

      - name: Run decoder
        run: |
          set -e
          echo 'Starting decoder run...'
          python -m subgraph_mining.decoder \
            --dataset=directed.pkl \
            --n_trials=200 \
            --node_anchored \
            --out_path=results/patterns.pkl \
            --graph_type=directed
          echo 'Checking output directories...'
          ls -la plots/cluster
          ls -la results

      # - name: Run pattern counter
      #   run: |
      #     set -e
      #     export PYTHONPATH=.
      #     echo 'Running pattern counter...'
      #     python -m analyze.count_patterns \
      #       --dataset=graph.pkl \
      #       --queries_path=results/patterns.pkl \
      #       --out_path=results/ \
      #       --node_anchored \
      #       --preserve_labels
      #     echo 'Counting completed.'
      #     ls -la results

      - name: Run matcher
        run: |
          set -e
          echo 'Starting matcher run on custom gene graph...'
          python -m subgraph_matching.train \
            --dataset=graph \
            --graph_pkl_path=graph.pkl \
            --node_anchored \
            --batch_size 16 \
            --val_size 128
          echo 'Checking output directories...'
          ls -la results
          ls -la plots

      - name: Check for generated files
        run: |
          echo "Checking plots directory:"
          ls -R plots/ || echo "No plots directory found"
          echo "Checking results directory:"
          ls -R results/ || echo "No results directory found"

      - name: Upload plots as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: decoder-plots
          path: |
            plots/
            results/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: decoder-logs
          path: |
            *.log
            *.err
          if-no-files-found: ignore